# 4.3 éƒ¨ç½²çŸ¥è¯†åº“åŠ©æ‰‹

æ­£æ–‡æ¶‰åŠåˆ°çš„æºæ–‡ä»¶å¯ä»Žå¦‚ä¸‹è·¯å¾„èŽ·å–ï¼š

> - [streamlit_app.py](https://github.com/datawhalechina/llm-universe/blob/main/notebook/C4%20%E6%9E%84%E5%BB%BA%20RAG%20%E5%BA%94%E7%94%A8/streamlit_app.py)

---

æˆ‘ä»¬å¯¹çŸ¥è¯†åº“å’ŒLLMå·²ç»æœ‰äº†åŸºæœ¬çš„ç†è§£ï¼ŒçŽ°åœ¨æ˜¯æ—¶å€™å°†å®ƒä»¬å·§å¦™åœ°èžåˆå¹¶æ‰“é€ æˆä¸€ä¸ªå¯Œæœ‰è§†è§‰æ•ˆæžœçš„ç•Œé¢äº†ã€‚è¿™æ ·çš„ç•Œé¢ä¸ä»…å¯¹æ“ä½œæ›´åŠ ä¾¿æ·ï¼Œè¿˜èƒ½ä¾¿äºŽä¸Žä»–äººåˆ†äº«ã€‚

Streamlit æ˜¯ä¸€ç§å¿«é€Ÿä¾¿æ·çš„æ–¹æ³•ï¼Œå¯ä»¥ç›´æŽ¥åœ¨ **Python ä¸­é€šè¿‡å‹å¥½çš„ Web ç•Œé¢æ¼”ç¤ºæœºå™¨å­¦ä¹ æ¨¡åž‹**ã€‚åœ¨æœ¬è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ *å¦‚ä½•ä½¿ç”¨å®ƒä¸ºç”Ÿæˆå¼äººå·¥æ™ºèƒ½åº”ç”¨ç¨‹åºæž„å»ºç”¨æˆ·ç•Œé¢*ã€‚åœ¨æž„å»ºäº†æœºå™¨å­¦ä¹ æ¨¡åž‹åŽï¼Œå¦‚æžœä½ æƒ³æž„å»ºä¸€ä¸ª demo ç»™å…¶ä»–äººçœ‹ï¼Œä¹Ÿè®¸æ˜¯ä¸ºäº†èŽ·å¾—åé¦ˆå¹¶æŽ¨åŠ¨ç³»ç»Ÿçš„æ”¹è¿›ï¼Œæˆ–è€…åªæ˜¯å› ä¸ºä½ è§‰å¾—è¿™ä¸ªç³»ç»Ÿå¾ˆé…·ï¼Œæ‰€ä»¥æƒ³æ¼”ç¤ºä¸€ä¸‹ï¼šStreamlit å¯ä»¥è®©æ‚¨é€šè¿‡ Python æŽ¥å£ç¨‹åºå¿«é€Ÿå®žçŽ°è¿™ä¸€ç›®æ ‡ï¼Œè€Œæ— éœ€ç¼–å†™ä»»ä½•å‰ç«¯ã€ç½‘é¡µæˆ– JavaScript ä»£ç ã€‚


## ä¸€ã€Streamlit ç®€ä»‹


`Streamlit` æ˜¯ä¸€ä¸ªç”¨äºŽå¿«é€Ÿåˆ›å»ºæ•°æ®åº”ç”¨ç¨‹åºçš„å¼€æº Python åº“ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯è®©æ•°æ®ç§‘å­¦å®¶èƒ½å¤Ÿè½»æ¾åœ°å°†æ•°æ®åˆ†æžå’Œæœºå™¨å­¦ä¹ æ¨¡åž‹è½¬åŒ–ä¸ºå…·æœ‰äº¤äº’æ€§çš„ Web åº”ç”¨ç¨‹åºï¼Œè€Œæ— éœ€æ·±å…¥äº†è§£ Web å¼€å‘ã€‚å’Œå¸¸è§„ Web æ¡†æž¶ï¼Œå¦‚ Flask/Django çš„ä¸åŒä¹‹å¤„åœ¨äºŽï¼Œå®ƒä¸éœ€è¦ä½ åŽ»ç¼–å†™ä»»ä½•å®¢æˆ·ç«¯ä»£ç ï¼ˆHTML/CSS/JSï¼‰ï¼Œåªéœ€è¦ç¼–å†™æ™®é€šçš„ Python æ¨¡å—ï¼Œå°±å¯ä»¥åœ¨å¾ˆçŸ­çš„æ—¶é—´å†…åˆ›å»ºç¾Žè§‚å¹¶å…·å¤‡é«˜åº¦äº¤äº’æ€§çš„ç•Œé¢ï¼Œä»Žè€Œå¿«é€Ÿç”Ÿæˆæ•°æ®åˆ†æžæˆ–è€…æœºå™¨å­¦ä¹ çš„ç»“æžœï¼›å¦ä¸€æ–¹é¢ï¼Œå’Œé‚£äº›åªèƒ½é€šè¿‡æ‹–æ‹½ç”Ÿæˆçš„å·¥å…·ä¹Ÿä¸åŒçš„æ˜¯ï¼Œä½ ä»ç„¶å…·æœ‰å¯¹ä»£ç çš„å®Œæ•´æŽ§åˆ¶æƒã€‚

Streamlit æä¾›äº†ä¸€ç»„ç®€å•è€Œå¼ºå¤§çš„åŸºç¡€æ¨¡å—ï¼Œç”¨äºŽæž„å»ºæ•°æ®åº”ç”¨ç¨‹åºï¼š

- st.write()ï¼šè¿™æ˜¯æœ€åŸºæœ¬çš„æ¨¡å—ä¹‹ä¸€ï¼Œç”¨äºŽåœ¨åº”ç”¨ç¨‹åºä¸­å‘ˆçŽ°æ–‡æœ¬ã€å›¾åƒã€è¡¨æ ¼ç­‰å†…å®¹ã€‚

- st.title()ã€st.header()ã€st.subheader()ï¼šè¿™äº›æ¨¡å—ç”¨äºŽæ·»åŠ æ ‡é¢˜ã€å­æ ‡é¢˜å’Œåˆ†ç»„æ ‡é¢˜ï¼Œä»¥ç»„ç»‡åº”ç”¨ç¨‹åºçš„å¸ƒå±€ã€‚

- st.text()ã€st.markdown()ï¼šç”¨äºŽæ·»åŠ æ–‡æœ¬å†…å®¹ï¼Œæ”¯æŒ Markdown è¯­æ³•ã€‚

- st.image()ï¼šç”¨äºŽæ·»åŠ å›¾åƒåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚

- st.dataframe()ï¼šç”¨äºŽå‘ˆçŽ° Pandas æ•°æ®æ¡†ã€‚

- st.table()ï¼šç”¨äºŽå‘ˆçŽ°ç®€å•çš„æ•°æ®è¡¨æ ¼ã€‚

- st.pyplot()ã€st.altair_chart()ã€st.plotly_chart()ï¼šç”¨äºŽå‘ˆçŽ° Matplotlibã€Altair æˆ– Plotly ç»˜åˆ¶çš„å›¾è¡¨ã€‚

- st.selectbox()ã€st.multiselect()ã€st.slider()ã€st.text_input()ï¼šç”¨äºŽæ·»åŠ äº¤äº’å¼å°éƒ¨ä»¶ï¼Œå…è®¸ç”¨æˆ·åœ¨åº”ç”¨ç¨‹åºä¸­è¿›è¡Œé€‰æ‹©ã€è¾“å…¥æˆ–æ»‘åŠ¨æ“ä½œã€‚

- st.button()ã€st.checkbox()ã€st.radio()ï¼šç”¨äºŽæ·»åŠ æŒ‰é’®ã€å¤é€‰æ¡†å’Œå•é€‰æŒ‰é’®ï¼Œä»¥è§¦å‘ç‰¹å®šçš„æ“ä½œã€‚

è¿™äº›åŸºç¡€æ¨¡å—ä½¿å¾—é€šè¿‡ Streamlit èƒ½å¤Ÿè½»æ¾åœ°æž„å»ºäº¤äº’å¼æ•°æ®åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”åœ¨ä½¿ç”¨æ—¶å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œç»„åˆå’Œå®šåˆ¶ï¼Œæ›´å¤šå†…å®¹è¯·æŸ¥çœ‹[å®˜æ–¹æ–‡æ¡£](https://docs.streamlit.io/get-started)

## äºŒã€æž„å»ºåº”ç”¨ç¨‹åº

é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Python æ–‡ä»¶å¹¶å°†å…¶ä¿å­˜ streamlit_app.pyåœ¨å·¥ä½œç›®å½•çš„æ ¹ç›®å½•ä¸­

1. å¯¼å…¥å¿…è¦çš„ Python åº“ã€‚


```python
import streamlit as st
from langchain_openai import ChatOpenAI
```

2. åˆ›å»ºåº”ç”¨ç¨‹åºçš„æ ‡é¢˜`st.title`


```python
st.title('ðŸ¦œðŸ”— åŠ¨æ‰‹å­¦å¤§æ¨¡åž‹åº”ç”¨å¼€å‘')
```

3. æ·»åŠ ä¸€ä¸ªæ–‡æœ¬è¾“å…¥æ¡†ï¼Œä¾›ç”¨æˆ·è¾“å…¥å…¶ OpenAI API å¯†é’¥


```python
openai_api_key = st.sidebar.text_input('OpenAI API Key', type='password')
```

4. å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œä½¿ç”¨ç”¨æˆ·å¯†é’¥å¯¹ OpenAI API è¿›è¡Œèº«ä»½éªŒè¯ã€å‘é€æç¤ºå¹¶èŽ·å– AI ç”Ÿæˆçš„å“åº”ã€‚è¯¥å‡½æ•°æŽ¥å—ç”¨æˆ·çš„æç¤ºä½œä¸ºå‚æ•°ï¼Œå¹¶ä½¿ç”¨`st.info`æ¥åœ¨è“è‰²æ¡†ä¸­æ˜¾ç¤º AI ç”Ÿæˆçš„å“åº”


```python
def generate_response(input_text):
    llm = ChatOpenAI(temperature=0.7, openai_api_key=openai_api_key)
    st.info(llm(input_text))
```

5. æœ€åŽï¼Œä½¿ç”¨`st.form()`åˆ›å»ºä¸€ä¸ªæ–‡æœ¬æ¡†ï¼ˆst.text_area()ï¼‰ä¾›ç”¨æˆ·è¾“å…¥ã€‚å½“ç”¨æˆ·å•å‡»`Submit`æ—¶ï¼Œ`generate-response()`å°†ä½¿ç”¨ç”¨æˆ·çš„è¾“å…¥ä½œä¸ºå‚æ•°æ¥è°ƒç”¨è¯¥å‡½æ•°


```python
with st.form('my_form'):
    text = st.text_area('Enter text:', 'What are the three key pieces of advice for learning how to code?')
    submitted = st.form_submit_button('Submit')
    if not openai_api_key.startswith('sk-'):
        st.warning('Please enter your OpenAI API key!', icon='âš ')
    if submitted and openai_api_key.startswith('sk-'):
        generate_response(text)
```

6. ä¿å­˜å½“å‰çš„æ–‡ä»¶`streamlit_app.py`ï¼

7. è¿”å›žè®¡ç®—æœºçš„ç»ˆç«¯ä»¥è¿è¡Œè¯¥åº”ç”¨ç¨‹åº



```python
streamlit run streamlit_app.py
```

ç»“æžœå±•ç¤ºå¦‚ä¸‹ï¼š  
  
![](../figures/C6-3-streamlit_app.png)

ä½†æ˜¯å½“å‰åªèƒ½è¿›è¡Œå•è½®å¯¹è¯ï¼Œæˆ‘ä»¬å¯¹ä¸Šè¿°åšäº›ä¿®æ”¹ï¼Œé€šè¿‡ä½¿ç”¨ `st.session_state` æ¥å­˜å‚¨å¯¹è¯åŽ†å²ï¼Œå¯ä»¥åœ¨ç”¨æˆ·ä¸Žåº”ç”¨ç¨‹åºäº¤äº’æ—¶ä¿ç•™æ•´ä¸ªå¯¹è¯çš„ä¸Šä¸‹æ–‡ã€‚
  
![](../figures/C6-3-streamlit_app2.png)
  
å…·ä½“ä»£ç å¦‚ä¸‹ï¼š


```python
# Streamlit åº”ç”¨ç¨‹åºç•Œé¢
def main():
    st.title('ðŸ¦œðŸ”— åŠ¨æ‰‹å­¦å¤§æ¨¡åž‹åº”ç”¨å¼€å‘')
    openai_api_key = st.sidebar.text_input('OpenAI API Key', type='password')

    # ç”¨äºŽè·Ÿè¸ªå¯¹è¯åŽ†å²
    if 'messages' not in st.session_state:
        st.session_state.messages = []

    messages = st.container(height=300)
    if prompt := st.chat_input("Say something"):
        # å°†ç”¨æˆ·è¾“å…¥æ·»åŠ åˆ°å¯¹è¯åŽ†å²ä¸­
        st.session_state.messages.append({"role": "user", "text": prompt})

        # è°ƒç”¨ respond å‡½æ•°èŽ·å–å›žç­”
        answer = generate_response(prompt, openai_api_key)
        # æ£€æŸ¥å›žç­”æ˜¯å¦ä¸º None
        if answer is not None:
            # å°†LLMçš„å›žç­”æ·»åŠ åˆ°å¯¹è¯åŽ†å²ä¸­
            st.session_state.messages.append({"role": "assistant", "text": answer})

        # æ˜¾ç¤ºæ•´ä¸ªå¯¹è¯åŽ†å²
        for message in st.session_state.messages:
            if message["role"] == "user":
                messages.chat_message("user").write(message["text"])
            elif message["role"] == "assistant":
                messages.chat_message("assistant").write(message["text"])   
```

## ä¸‰ã€æ·»åŠ æ£€ç´¢é—®ç­”

å…ˆå°†`2.æž„å»ºæ£€ç´¢é—®ç­”é“¾`éƒ¨åˆ†çš„ä»£ç è¿›è¡Œå°è£…ï¼š
- get_vectordbå‡½æ•°è¿”å›žC3éƒ¨åˆ†æŒä¹…åŒ–åŽçš„å‘é‡çŸ¥è¯†åº“
- get_chat_qa_chainå‡½æ•°è¿”å›žè°ƒç”¨å¸¦æœ‰åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”é“¾åŽçš„ç»“æžœ
- get_qa_chainå‡½æ•°è¿”å›žè°ƒç”¨ä¸å¸¦æœ‰åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”é“¾åŽçš„ç»“æžœ


```python
def get_vectordb():
    # å®šä¹‰ Embeddings
    embedding = ZhipuAIEmbeddings()
    # å‘é‡æ•°æ®åº“æŒä¹…åŒ–è·¯å¾„
    persist_directory = '../C3 æ­å»ºçŸ¥è¯†åº“/data_base/vector_db/chroma'
    # åŠ è½½æ•°æ®åº“
    vectordb = Chroma(
        persist_directory=persist_directory,  # å…è®¸æˆ‘ä»¬å°†persist_directoryç›®å½•ä¿å­˜åˆ°ç£ç›˜ä¸Š
        embedding_function=embedding
    )
    return vectordb

#å¸¦æœ‰åŽ†å²è®°å½•çš„é—®ç­”é“¾
def get_chat_qa_chain(question:str,openai_api_key:str):
    vectordb = get_vectordb()
    llm = ChatOpenAI(model_name = "gpt-3.5-turbo", temperature = 0,openai_api_key = openai_api_key)
    memory = ConversationBufferMemory(
        memory_key="chat_history",  # ä¸Ž prompt çš„è¾“å…¥å˜é‡ä¿æŒä¸€è‡´ã€‚
        return_messages=True  # å°†ä»¥æ¶ˆæ¯åˆ—è¡¨çš„å½¢å¼è¿”å›žèŠå¤©è®°å½•ï¼Œè€Œä¸æ˜¯å•ä¸ªå­—ç¬¦ä¸²
    )
    retriever=vectordb.as_retriever()
    qa = ConversationalRetrievalChain.from_llm(
        llm,
        retriever=retriever,
        memory=memory
    )
    result = qa({"question": question})
    return result['answer']

#ä¸å¸¦åŽ†å²è®°å½•çš„é—®ç­”é“¾
def get_qa_chain(question:str,openai_api_key:str):
    vectordb = get_vectordb()
    llm = ChatOpenAI(model_name = "gpt-3.5-turbo", temperature = 0,openai_api_key = openai_api_key)
    template = """ä½¿ç”¨ä»¥ä¸‹ä¸Šä¸‹æ–‡æ¥å›žç­”æœ€åŽçš„é—®é¢˜ã€‚å¦‚æžœä½ ä¸çŸ¥é“ç­”æ¡ˆï¼Œå°±è¯´ä½ ä¸çŸ¥é“ï¼Œä¸è¦è¯•å›¾ç¼–é€ ç­”
        æ¡ˆã€‚æœ€å¤šä½¿ç”¨ä¸‰å¥è¯ã€‚å°½é‡ä½¿ç­”æ¡ˆç®€æ˜Žæ‰¼è¦ã€‚æ€»æ˜¯åœ¨å›žç­”çš„æœ€åŽè¯´â€œè°¢è°¢ä½ çš„æé—®ï¼â€ã€‚
        {context}
        é—®é¢˜: {question}
        """
    QA_CHAIN_PROMPT = PromptTemplate(input_variables=["context","question"],
                                 template=template)
    qa_chain = RetrievalQA.from_chain_type(llm,
                                       retriever=vectordb.as_retriever(),
                                       return_source_documents=True,
                                       chain_type_kwargs={"prompt":QA_CHAIN_PROMPT})
    result = qa_chain({"query": question})
    return result["result"]
```

ç„¶åŽï¼Œæ·»åŠ ä¸€ä¸ªå•é€‰æŒ‰é’®éƒ¨ä»¶`st.radio`ï¼Œé€‰æ‹©è¿›è¡Œé—®ç­”çš„æ¨¡å¼ï¼š
- Noneï¼šä¸ä½¿ç”¨æ£€ç´¢é—®ç­”çš„æ™®é€šæ¨¡å¼
- qa_chainï¼šä¸å¸¦åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼
- chat_qa_chainï¼šå¸¦åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼


```python
selected_method = st.radio(
        "ä½ æƒ³é€‰æ‹©å“ªç§æ¨¡å¼è¿›è¡Œå¯¹è¯ï¼Ÿ",
        ["None", "qa_chain", "chat_qa_chain"],
        captions = ["ä¸ä½¿ç”¨æ£€ç´¢é—®ç­”çš„æ™®é€šæ¨¡å¼", "ä¸å¸¦åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼", "å¸¦åŽ†å²è®°å½•çš„æ£€ç´¢é—®ç­”æ¨¡å¼"])
```

æœ€ç»ˆçš„æ•ˆæžœå¦‚ä¸‹ï¼š  
  
![](../figures/C6-3-streamlit_app3.png)

è¿›å…¥é¡µé¢ï¼Œé¦–å…ˆå…ˆè¾“å…¥OPEN_API_KEYï¼ˆé»˜è®¤ï¼‰ï¼Œç„¶åŽç‚¹å‡»å•é€‰æŒ‰é’®é€‰æ‹©è¿›è¡Œé—®ç­”çš„æ¨¡å¼ï¼Œæœ€åŽåœ¨è¾“å…¥æ¡†è¾“å…¥ä½ çš„é—®é¢˜ï¼ŒæŒ‰ä¸‹å›žè½¦å³å¯ï¼

> å®Œæ•´ä»£ç å‚è€ƒ[streamlit_app.py](./streamlit_app.py)

## å››ã€éƒ¨ç½²åº”ç”¨ç¨‹åº  

è¦å°†åº”ç”¨ç¨‹åºéƒ¨ç½²åˆ° Streamlit Cloudï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š  
  
1. ä¸ºåº”ç”¨ç¨‹åºåˆ›å»º GitHub å­˜å‚¨åº“ã€‚æ‚¨çš„å­˜å‚¨åº“åº”åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼š  
  
   your-repository/  
   â”œâ”€â”€ streamlit_app.py  
   â””â”€â”€ requirements.txt  
  
2. è½¬åˆ° [Streamlit Community Cloud](http://share.streamlit.io/)ï¼Œå•å‡»å·¥ä½œåŒºä¸­çš„`New app`æŒ‰é’®ï¼Œç„¶åŽæŒ‡å®šå­˜å‚¨åº“ã€åˆ†æ”¯å’Œä¸»æ–‡ä»¶è·¯å¾„ã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥é€šè¿‡é€‰æ‹©è‡ªå®šä¹‰å­åŸŸæ¥è‡ªå®šä¹‰åº”ç”¨ç¨‹åºçš„ URL
  
3. ç‚¹å‡»`Deploy!`æŒ‰é’®  
  
æ‚¨çš„åº”ç”¨ç¨‹åºçŽ°åœ¨å°†éƒ¨ç½²åˆ° Streamlit Community Cloudï¼Œå¹¶ä¸”å¯ä»¥ä»Žä¸–ç•Œå„åœ°è®¿é—®ï¼ ðŸŒŽ  

æˆ‘ä»¬çš„é¡¹ç›®éƒ¨ç½²åˆ°è¿™åŸºæœ¬å®Œæˆï¼Œä¸ºäº†æ–¹ä¾¿è¿›è¡Œæ¼”ç¤ºè¿›è¡Œäº†ç®€åŒ–ï¼Œè¿˜æœ‰å¾ˆå¤šå¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–çš„åœ°æ–¹ï¼ŒæœŸå¾…å­¦ä¹ è€…ä»¬è¿›è¡Œå„ç§é­”æ”¹ï¼

ä¼˜åŒ–æ–¹å‘ï¼š
- ç•Œé¢ä¸­æ·»åŠ ä¸Šä¼ æœ¬åœ°æ–‡æ¡£ï¼Œå»ºç«‹å‘é‡æ•°æ®åº“çš„åŠŸèƒ½
- æ·»åŠ å¤šç§LLM ä¸Ž embeddingæ–¹æ³•é€‰æ‹©çš„æŒ‰é’®
- æ·»åŠ ä¿®æ”¹å‚æ•°çš„æŒ‰é’®
- æ›´å¤š......

---

#### ä¸Šè¿°æ¶‰åŠåˆ°çš„æºæ–‡ä»¶èŽ·å–è·¯å¾„ï¼š

> - [streamlit_app.py](https://github.com/datawhalechina/llm-universe/blob/main/notebook/C4%20%E6%9E%84%E5%BB%BA%20RAG%20%E5%BA%94%E7%94%A8/streamlit_app.py)